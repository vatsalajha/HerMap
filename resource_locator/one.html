<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Her-Map</title>
    <style>
      .navbar {
        background-color: #ff99cc;
        padding: 10px;
        text-align: center;
        color: white;
        font-size: 18px;
      }
      #map {
        height: 93vh;
        width: 60%;
        margin-bottom: 20px;
      }

      .washroom-info {
        padding: 15px;
        max-width: 350px;
        font-family: system-ui, -apple-system, sans-serif;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        background: white;
        border: 1px solid #ddd;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-available {
        background-color: #22c55e;
      }
      .status-low {
        background-color: #f59e0b;
      }
      .status-unavailable {
        background-color: #dc2626;
      }
      #updatesContainer {
        margin: 20px;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .update-card {
        margin-bottom: 10px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
      }

      .verified-badge {
        background-color: #28a745;
        color: white;
        padding: 4px 6px;
        font-size: 12px;
        border-radius: 4px;
        margin-left: 5px;
      }

      iframe {
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <span>Her-Map : Menstrual Hygeine With Ease</span>
    </div>
    <div id="map"></div>

    <script>
      async function loadGoogleMaps() {
        try {
          console.log("üîç Fetching API key...");
          const response = await fetch("http://localhost:5001/config");
          const config = await response.json();
          console.log("‚úÖ API Key:", config.apiKey);

          const script = document.createElement("script");
          script.src = `https://maps.googleapis.com/maps/api/js?key=${config.apiKey}&libraries=places`;
          document.head.appendChild(script);

          script.onload = () => fetchWashrooms();
        } catch (error) {
          console.error("‚ùå Error fetching API key:", error);
        }
      }

      async function fetchWashrooms() {
        try {
          console.log("üîç Fetching washroom data...");
          const response = await fetch("http://localhost:5001/washrooms");
          const washroomLocations = await response.json();
          console.log("‚úÖ Washrooms:", washroomLocations);

          initMap(washroomLocations);
        } catch (error) {
          console.error("‚ùå Error fetching washroom data:", error);
        }
      }

      function initMap(washroomLocations) {
        const rutgers = { lat: 40.5006, lng: -74.4474 };
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: rutgers,
          styles: [
            // {
            //   featureType: "all",
            //   elementType: "geometry",
            //   stylers: [{ color: "#e9e9e9" }],
            // },
            {
              featureType: "poi",
              elementType: "labels",
              stylers: [{ visibility: "off" }],
            },
            {
              featureType: "poi.business",
              // elementType: "geometry",
              stylers: [{ visibility: "off" }],
            },
          ],
        });

        const infoWindow = new google.maps.InfoWindow();

        washroomLocations.forEach((washroom) => {
          const marker = new google.maps.Marker({
            position: washroom.location,
            map: map,
            title: washroom.name,
            // icon: {
            //   url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
            //   scaledSize: new google.maps.Size(32, 32),
            // },
          });

          marker.addListener("click", () => {
            const content = createInfoWindowContent(washroom);
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
          });
        });
      }

      function createInfoWindowContent(washroom) {
        let content = `<div class="washroom-info"><h3>${washroom.name}</h3>`;

        washroom.floors.forEach((floor) => {
          content += `
            <div style="
                margin-top: 10px;
                padding: 10px;
                border-radius: 8px;
                background: #f9f9f9;
                border: 1px solid #ddd;
            ">
                <h4 style="margin: 0 0 6px 0; font-size: 16px;">${
                  floor.level
                }</h4>
                
                <p style="display: flex; align-items: center; margin: 4px 0;">
                <span style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    margin-right: 6px;
                    background-color: ${
                      floor.status.pads === "available"
                        ? "#22c55e"
                        : floor.status.pads === "low"
                        ? "#f59e0b"
                        : "#dc2626"
                    };
                "></span> 
                <strong>Pads:</strong> <span style="margin-left: 4px;">${
                  floor.status.pads
                }</span>
            </p>

            <p style="display: flex; align-items: center; margin: 4px 0;">
                <span style="
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    margin-right: 6px;
                    background-color: ${
                      floor.status.tampons === "available"
                        ? "#22c55e"
                        : floor.status.tampons === "low"
                        ? "#f59e0b"
                        : "#dc2626"
                    };
                "></span> 
                <strong>Tampons:</strong> <span style="margin-left: 4px;">${
                  floor.status.tampons
                }</span>
            </p>

                <p style="margin: 8px 0; font-size: 14px;">
                    ${
                      floor.accessibility
                        ? "‚ôø <strong>Accessible</strong>"
                        : "‚ö†Ô∏è <strong>Not accessible</strong>"
                    } <br>
                    ${
                      floor.vendingMachine
                        ? "üèß <strong>Vending machine available</strong>"
                        : "‚ùå <strong>No vending machine</strong>"
                    } <br>
                    ${
                      floor.status.waterFilter === "Working"
                        ? "üíß <strong>Water filter working</strong>"
                        : "‚ùå <strong>Water filter not working</strong>"
                    }
                </p>

                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    ${floor.status.lastUpdated}
                </p>

                <button onclick="window.location.href = 'update_status.html?id=${
                  washroom.id
                }&name=${washroom.name}&floor=${floor.level}'" style="
                width: 100%;
                padding: 10px;
                border: none;
                background: #4299e1;
                color: white;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: 0.3s;
            ">Update Status</button>

            </div>
        `;
        });

        content += "</div>";
        return content;
      }

      // ‚úÖ Load Google Maps API and fetch washrooms
      loadGoogleMaps();
    </script>
    <div
      style="
        position: absolute;
        bottom: 0;
        right: 0;
        width: 40%;
        height: 94%;
        border: 1px solid #ddd;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        background: white;
        overflow: hidden;
      "
    >
      <iframe
        src="https://67ae-128-6-147-1.ngrok-free.app"
        width="100%"
        height="100%"
        frameborder="0"
      >
      </iframe>
    </div>
  </body>
</html>
